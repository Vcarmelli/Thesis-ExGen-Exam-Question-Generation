{% extends 'layout/dashboard.html'%}

{% block title %}Home{% endblock %}

{% block content%}
    <div class="my-library-container">
        <div class="header-container">
            <a class="btn back-btn" href="{{ url_for('library.library_page') }}">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1>My Library</h1>
        </div>
        <div class="btn-container">
            <a class="btn primary" href="{{ url_for('preview.load_file', setId=setId) }}">
                <i class="fa-solid fa-plus"></i>New Questions</a>
            <a class="btn secondary" href="{{ url_for('key_upload.key_upload_page')}}">
                <i class="fa-solid fa-key"></i>Generate Keynotes</a>
        </div>
    </div>

    <div class="continue-card-container">
        {% for question in generated_questions %}
            <div class="question-card">
                <div class="continue-card action library">
                    <div class="quill-container" id="question-answer-{{ loop.index }}">
                        <div class="bloom-option {{ question.bloom }}">{{ question.bloom_level }}</div>

                        <h4><strong>Question {{ loop.index }}:</strong> {{ question.question_text }}</h4>
                        <ul>
                            {% for letter, option in question.options.items() %}
                                <li style="list-style-type: none; font-size: 1rem;"><span>{{ letter }} {% if option %}) {{ option }} {% endif %}</span></li>
                            {% endfor %}
                        </ul>
                        <p><strong>Answer:</strong> {{ question.answer }}</p>
                    </div>
                </div>
                <div class="continue-card action">
                    <div class="update-question" data-question-id="{{ question.id }}"><img class="edit-delete-btn" src="../static/assets/Edit.png"></div>
                    <div class="delete-question" data-question-id="{{ question.id }}"><img class="edit-delete-btn" src="../static/assets/Delete.png"></div>
                </div>
            </div>
        {% endfor %}
    </div>

     <!-- Edit Modal -->
     <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="red-line"></div>
            <form method="POST" id="editForm">
                <div class="input-container">
                    <div class="input-label">
                        <h1>Edit Question</h1>
                        <input type="text" name="question" id="question">
                    </div>
                </div>
                <div class="input-container" id="option-container">
                    <p>Options</p>
                    <div class="options-wrapper">
                    </div>
                </div>
                <div class="input-container">
                    <div class="input-label">
                        <label for="answer">Answer</label>
                        <input type="text" name="answer" id="answer">
                    </div>
                </div>
                <input type="hidden" name="question-id" id="question-id">
                <div class="edit-btn-container">
                    <button type="button" onclick="confirmEdit()">Confirm</button>
                    <button type="button" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal for Delete -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <div class="red-line"></div>
            <h2>Confirm Delete</h2>
            <p>Are you sure you want to delete this question? This action cannot be undone.</p>
            <div class="edit-btn-container">
                <button type="button" onclick="confirmDelete()">Delete</button>
                <button type="button" onclick="closeDeleteModal()">Cancel</button>
            </div>
            <input type="hidden" id="delete-question-id">
        </div>
    </div>

    <!-- Confirmation Modal for Edit -->
    <div id="editConfirmModal" class="modal">
        <div class="modal-content">
            <div class="red-line"></div>
            <h2>Confirm Changes</h2>
            <p>Are you sure you want to save these changes?</p>
            <div class="edit-btn-container">
                <button type="button" onclick="submitEditForm()">Save Changes</button>
                <button type="button" onclick="closeEditConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('editModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        const editConfirmModal = document.getElementById('editConfirmModal');

        function closeModal() {
            modal.style.display = "none";
        }

        function closeDeleteModal() {
            deleteModal.style.display = "none";
        }
        
        function closeEditConfirmModal() {
            editConfirmModal.style.display = "none";
        }

        function deleteQuestion(questionId) {
            document.getElementById('delete-question-id').value = questionId;
            deleteModal.style.display = "block";
        }
        
        function confirmDelete() {
            const questionId = document.getElementById('delete-question-id').value;
            closeDeleteModal();
           
            fetch(`/library/delete`, {
                method: 'POST',
                body: JSON.stringify({ questionId: questionId })
            })
            .then(response => response.json())
            .then(data => {
                const setId = data.setId; 
                window.location.href = `/library/${setId}`; 
            });
        }
        
        function confirmEdit() {
            editConfirmModal.style.display = "block";
        }
        
        function submitEditForm() {
            closeEditConfirmModal();

            document.getElementById('editForm').submit();
        }

        function showModal(questionId) {
            fetch( `/library/retrieve`, {
                method: 'POST',
                body: JSON.stringify({ questionId: questionId })
            })
            .then(response => response.json())
            .then(data => {
                const question = data.question; 
                const optionsContainer = document.querySelector('#option-container');
                const optionsWrapper = document.querySelector('.options-wrapper');
                document.getElementById('question-id').value = question.id;
                document.getElementById('question').value = question.question_text;
                document.getElementById('answer').value = question.answer;

                if (question.options) {
                    optionsWrapper.innerHTML = '';
                    Object.entries(question.options).forEach(([key, value], index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'input-label';

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'option';
                        input.value = `${value}`;

                        optionDiv.appendChild(input);
                        optionsWrapper.appendChild(optionDiv);
                        optionsContainer.style.display = 'block';
                    });
                }

                console.log(question);
                modal.style.display = "block";
            });
        }

        document.addEventListener("DOMContentLoaded", function() {

            const quesCards = document.querySelectorAll('.question-card');
            // Apply staggered animation delay
            quesCards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('visible');
                }, 100 * index);
            });

            const updateBtn = document.querySelectorAll('.update-question');
            const deleteBtn = document.querySelectorAll('.delete-question');
            
            updateBtn.forEach(function(question) {
                question.addEventListener('click', () => showModal(question.getAttribute('data-question-id')));
            });

            deleteBtn.forEach(function(question) {
                question.addEventListener('click', () => deleteQuestion(question.getAttribute('data-question-id')));
            });
        });        
    </script>
{% endblock %}
