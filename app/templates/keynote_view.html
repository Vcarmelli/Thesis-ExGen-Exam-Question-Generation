{% extends 'layout/dashboard.html'%}

{% block title %}{{ filename }} - Keynote{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/keynote_view.css') }}">

<div class="keynote-view-container">
    <div class="header-container">
        <div class="header-top-row">
            <a class="back-btn" href="{{ url_for('library.library_page') }}">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <h1>{{ keynote.title }}</h1>
        </div>
        <div class="meta-info">
            <p>Created: {{ keynote.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% if keynote.file_path %}
            <p>Source: {{ keynote.file_path }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Moved export footer to the top to match CSS positioning -->
    <div class="export-footer">
        <div class="export-controls">
            <a class="export-control-btn" href="{{ url_for('key_export.export_keynotes_pdf') }}">
                <span class="material-symbols-outlined">picture_as_pdf</span>
                Export to PDF
            </a>
            <a class="export-control-btn" href="{{ url_for('key_export.export_keynotes_docx') }}">
                <span class="material-symbols-outlined">description</span>
                Export to Word
            </a>
            <button class="delete-btn" onclick="deleteKeynote('{{ keynote.id }}')">
                <span class="material-symbols-outlined">delete</span>
                Delete
            </button>
        </div>
    </div>
    
    <div class="keynote-content" tabindex="0">
        {{ content | safe }}
    </div>

<script>
    // Deletion functionality
    function deleteKeynote(keynoteId) {
        if (!confirm('Are you sure you want to delete this keynote?')) {
            return;
        }
        
        fetch('/library/keynote/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keynoteId: keynoteId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show a styled notification instead of alert
                showNotification(data.message, 'success');
                
                // Redirect to library page after short delay
                setTimeout(() => {
                    window.location.href = "{{ url_for('library.library_page') }}";
                }, 1500);
            } else {
                showNotification(data.message || 'Failed to delete keynote', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while deleting the keynote', 'error');
        });
    }
    
    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }, 3000);
    }
    
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transform: translateY(-20px);
                opacity: 0;
                transition: all 0.3s ease;
                z-index: 1000;
            }
            
            .notification.show {
                transform: translateY(0);
                opacity: 1;
            }
            
            .notification.success {
                background-color: #4CAF50;
            }
            
            .notification.error {
                background-color: #f44336;
            }
            
            .notification.info {
                background-color: #2196F3;
            }
        </style>
    `);
    
    // Add scroll position restoration
    document.addEventListener('DOMContentLoaded', function() {
        // Add scroll position restoration
        const savedScrollPos = sessionStorage.getItem('keynoteScrollPosition');
        if (savedScrollPos) {
            window.scrollTo(0, parseInt(savedScrollPos));
        }
        
        // Save scroll position when navigating away
        window.addEventListener('beforeunload', function() {
            sessionStorage.setItem('keynoteScrollPosition', window.scrollY);
        });
    });
</script>
{% endblock %}