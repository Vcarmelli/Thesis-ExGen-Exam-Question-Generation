{% extends 'layout/dashboard.html'%}

{% block title %}Home{% endblock %}

{% block content%}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Welcome!</h1>
            <div class="action-buttons">
                <a class="btn primary" href="{{ url_for('upload.upload_page')}}">
                    <i class="fa-solid fa-plus"></i>Generate Exam</a>
                <a class="btn secondary" href="{{ url_for('key_upload.key_upload_page')}}">
                    <i class="fa-solid fa-key"></i>Generate Keynotes</a>
            </div>
        </header>
        
        <!-- Dashboard Stats Summary -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-file-lines"></i>
                </div>
                <div class="stat-value">{{ counts.values()|sum }}</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-folder"></i>
                </div>
                <div class="stat-value">{{ question_sets|length }}</div>
                <div class="stat-label">Question Sets</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
                <div class="stat-value">
                    {% if counts.values()|sum > 0 %}
                        {{ ((counts.get('create', 0) + counts.get('evaluate', 0) + counts.get('analyze', 0)) / counts.values()|sum * 100)|round|int }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="stat-label">Higher Order Questions</div>
            </div>
        </div>
    
        <!-- Bloom's Taxonomy Section - Card Layout -->
        <div class="bloom-section">
            <h2>Bloom's Taxonomy</h2>
            
            {% set icon = {
                'create': 'fa-pen-nib',
                'evaluate': 'fa-scale-balanced',
                'analyze': 'fa-magnifying-glass-chart',
                'apply': 'fa-comment-dots',
                'understand': 'fa-brain',
                'remember': 'fa-lightbulb'
            } %}
            
            {% set bloom_levels = ['create', 'evaluate', 'analyze', 'apply', 'understand', 'remember'] %}
            
            {% set bloom_descriptions = {
                'remember': 'Retrieving, recognizing, and recalling relevant knowledge from long‚Äêterm memory.',
                'understand': 'Constructing meaning from oral, written, and graphic messages.',
                'apply': 'Using a procedure for executing or implementing.',
                'analyze': 'Breaking material into parts and determining relationships.',
                'evaluate': 'Making judgments through checking and critiquing.',
                'create': 'Putting elements together to form a whole; generating new patterns.'
            } %}
            
            {% set bloom_verbs = {
                'remember': ['Define', 'List', 'Recall', 'Name', 'Identify'],
                'understand': ['Explain', 'Summarize', 'Paraphrase', 'Describe', 'Compare'],
                'apply': ['Use', 'Solve', 'Implement', 'Demonstrate', 'Calculate'],
                'analyze': ['Differentiate', 'Organize', 'Compare', 'Outline', 'Deconstruct'],
                'evaluate': ['Judge', 'Critique', 'Justify', 'Defend', 'Assess'],
                'create': ['Design', 'Develop', 'Formulate', 'Author', 'Construct']
            } %}
            
            <!-- Bloom's Card Layout -->
            <div class="bloom-cards-container">
                {% for bloom in bloom_levels %}
                <div class="bloom-card {{ bloom }}" data-level="{{ bloom }}">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fa-solid {{ icon.get(bloom, 'fa-circle-question') }}"></i>
                        </div>
                        <h3 class="card-title">{{ bloom|capitalize }}</h3>
                        <div class="card-count">{{ counts.get(bloom, 0) }}</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: {% if counts.values()|sum > 0 %}{{ (counts.get(bloom, 0) / counts.values()|sum * 100)|round|int }}{% else %}0{% endif %}%"></div>
                    </div>
                    <div class="card-description">
                        {{ bloom_descriptions.get(bloom, '') }}
                    </div>
                    <div class="verb-tags">
                        {% for verb in bloom_verbs.get(bloom, []) %}
                        <span class="verb-tag">{{ verb }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Mobile Bar Chart as fallback for very small screens -->
            <div class="bloom-bars-mobile">
                {% for bloom in bloom_levels|reverse %}
                    <div class="bloom-bar-container">
                        <div class="bar-label">
                            <i class="fa-solid {{ icon.get(bloom, 'fa-circle-question') }}"></i>
                            <span>{{ bloom|capitalize }}</span>
                        </div>
                        <div class="bar-outer">
                            <div class="bar-inner {{ bloom }}" style="width: {% if counts.values()|sum > 0 %}{{ (counts.get(bloom, 0) / counts.values()|sum * 100)|round|int }}{% else %}0{% endif %}%"></div>
                        </div>
                        <div class="bar-count">{{ counts.get(bloom, 0) }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="two-column-section">
            {% if question_sets or keynote_sets %}
            <div class="recent-sets">
                <h2>Continue Learning</h2>
                <div class="continue-card-container">
                    {% for set in question_sets[:2] %}
                    <div class="continue-card" data-set-id="{{ set.id }}">
                        <div class="set-info">
                            <h3>{{ set.title }}</h3>
                            <span class="question-count">
                                <i class="fa-solid fa-file-lines"></i>
                                {{ set.question_count() }} questions
                            </span>
                        </div>
                        <div class="set-actions">
                            <a href="{{ url_for('library.library_questions', setId=set.id) }}" class="continue-btn">
                                Continue
                                <i class="fa-solid fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% for keynote in keynote_sets[:1] %}
                    <div class="continue-card" data-keynote-id="{{ keynote.id }}">
                        <div class="set-info">
                            <h3>{{ keynote.title }}</h3>
                            <span class="keynote-info">
                                <i class="fa-solid fa-key"></i>
                                Keynotes
                            </span>
                        </div>
                        <div class="set-actions">
                            <a href="{{ url_for('library.view_keynote', keynoteId=keynote.id) }}" class="continue-btn">
                                Continue
                                <i class="fa-solid fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        
    <div class="recent-activity">
        <h2>Recent Activity</h2>
        <div class="activity-list">
            {% if recent_exams or recent_keynotes %}
                {% set combined = (recent_exams + recent_keynotes)|sort(attribute='created_at', reverse=True) %}
                {% for item in combined %}
                    {% if loop.index <= 5 %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            {% if item.__class__.__name__ == 'QuestionSet' %}
                                <i class="fa-solid fa-file-lines"></i>
                            {% else %}
                                <i class="fa-solid fa-key"></i>
                            {% endif %}
                        </div>
                        <div class="activity-details">
                            <div class="activity-title">{{ item.title }}</div>
                            <div class="activity-time">
                                Generated {{ item.created_at.strftime('%b %d, %I:%M %p') }}
                                {% if item.__class__.__name__ == 'Keynote' %}
                                (Keynote)
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <p>No recent activity</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const bloomCards = document.querySelectorAll('.bloom-card');
            
            // Apply staggered animation delay
            bloomCards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('visible');
                }, 100 * index);
            });
            
            // Add click event to cards
            bloomCards.forEach(card => {
                card.addEventListener('click', function() {
                    const isExpanded = this.classList.contains('expanded');
                    
                    // First collapse all cards
                    bloomCards.forEach(c => {
                        c.classList.remove('expanded', 'active');
                    });
                    
                    // Then expand clicked card if it wasn't expanded already
                    if (!isExpanded) {
                        this.classList.add('expanded', 'active');
                    }
                });
            });
            
            // Card click event for Continue Learning section
            const continueCards = document.querySelectorAll('.continue-card');
            continueCards.forEach(function(card) {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('.continue-btn')) {
                        const continueBtnLink = this.querySelector('.continue-btn').getAttribute('href');
                        if (continueBtnLink) {
                            window.location.href = continueBtnLink;
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}